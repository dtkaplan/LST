<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="LSTbook"><title>Simulating data with Directed Acyclic Graphs ‚Ä¢ LSTbook</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulating data with Directed Acyclic Graphs"><meta property="og:description" content="LSTbook"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">LSTbook</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.6</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/LSTbook.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/DAGs.html">Simulating data with Directed Acyclic Graphs</a>
    <a class="dropdown-item" href="../articles/modeling.html">Training models</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/dtkaplan/LSTbook/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Simulating data with Directed Acyclic Graphs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dtkaplan/LSTbook/blob/HEAD/docs/reference/vignettes/DAGs.Rmd" class="external-link"><code>docs/reference/vignettes/DAGs.Rmd</code></a></small>
      <div class="d-none name"><code>DAGs.Rmd</code></div>
    </div>

    
    
<p>Instructors often hear that students should work with ‚Äúreal‚Äù data,
that is, data from actual observations or experiments. Such ‚Äúreal‚Äù data
is used throughout <em>Lessons in Statistical Thinking</em> and serves
several purposes: motivating students, creating verisimilitude, and
exercising the statistical thinking skill of recognizing that one‚Äôs
findings from data may not reflect the reality that created the
data.</p>
<p>But there is also an important use for ‚Äúunreal,‚Äù simulated data. The
user-defined rules of the simulation stands for reality, providing a
chance to see if the results of analyzing the data correspond with that
reality. Another way to say this is that the use of simulated data
allows one to look at <strong>accuracy</strong> and
<strong>bias</strong>. As well, simulations provide a direct way to
observe sampling variation, since a given simulation can be run multiple
times.</p>
<p>In the <code>{LST}</code> package, data simulations are provided by a
handful of purpose-written functions, particularly
<code>datasim_make()</code> and <code>datasim_run()</code>. Simulation
is always a two-step process: (1) create the rules by which the
simulation works and (2) apply those rules using random-number
generators to generate data. To illustrate the process, consider a very
simple simulation in which a random <code>x</code> is generated, which
is used to produce a <code>y</code> by a linear transformation of the
<code>x</code>. The two simulated variables are then packaged as a data
frame.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>Example1 <span class="ot">&lt;-</span> <span class="fu">datasim_make</span>(</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">2</span>), </span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">+</span> <span class="dv">10</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>Example1 <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n=</span><span class="dv">6</span>,  <span class="at">seed =</span> <span class="dv">101</span>)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 6 √ó 2[39m</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co">#&gt;        x       y</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co">#&gt;    [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m -[31m0[39m[31m.[39m[31m652[39m  -[31m6[39m[31m.[39m[31m43[39m </span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co">#&gt; [38;5;250m2[39m  1.10    7.49 </span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">#&gt; [38;5;250m3[39m -[31m1[39m[31m.[39m[31m35[39m  -[31m11[39m[31m.[39m[31m9[39m  </span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="co">#&gt; [38;5;250m4[39m  0.429   0.171</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="co">#&gt; [38;5;250m5[39m  0.622   5.85 </span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co">#&gt; [38;5;250m6[39m  2.35   16.5</span></span></code></pre></div>
<p><code>Example1</code> is a simulation with two rules: <code>x</code>
is a random normal variable (with the specified mean and standard
deviation) and <code>y</code> is an arithmetic transformation of
<code>x</code>.</p>
<p>For readers interested in details, we‚Äôll explain in <span
class="citation">@sec-why-datasim</span> why the choice was taken to
arrange things as this two-step process. For the present, however, we
will continue without worrying about the design choices.</p>
<div id="basics-of-datasim_make" class="section level2">
<h2>Basics of <code>datasim_make()</code></h2>
<p>Each of the rules of a simulation is written in the syntax of an
ordinary R statement. Within any one simulation objects, each rule must
have a unique name. For example,
<code>x &lt;- rnorm(n, mean=0, sd=2)</code>, is a perfectly ordinary R
statement, storing under the name <code>x</code> the rule
<code>rnorm(n, mean=0, sd=2)</code>.</p>
<p><code>datasim_make()</code> is a <strong>function</strong>; the
simulation rules are given as <strong>arguments</strong> to the
function, that is, in parentheses and separated by commas.</p>
<p>But there are three aspects of using <code>datasim_make()</code> that
are entirely out of the ordinary. First, the name is given to each of
the rules using the storage arrow (<code>&lt;-</code>) as opposed to the
usual <code>=</code> syntax for named arguments. Using <code>=</code>
will generate an error, like this.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>Wrong_way <span class="ot">&lt;-</span> <span class="fu">datasim_make</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(n, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span><span class="dv">2</span>)) <span class="co"># don&#39;t use =</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co">#&gt; Error in datasim_make(x = rnorm(n, mean = 0, sd = 2)): Use the storage arrow `&lt;-` (not the equation sign `=`) in arguments to datasim_make().</span></span></code></pre></div>
<p>Second, the quantity <code>n</code> does <strong>not</strong> need to
be defined previously; it will be defined in the sampling phase.</p>
<p>Third, a rule may make use of a name (like <code>x</code>) only when
that name has been used for a previous rule. For instance, the second
rule in <code>Example1</code> is <code>y &lt;- -3 + 10 * x</code> and
uses the <code>x</code> defined in the first rule. More rules, each with
its own unique name, can be added that make use of <code>x</code> and
<code>y</code>.</p>
<p>Once a set of rules has been collected using
<code>datasim_make()</code>, the simulation can be run as many times as
you like.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>Example1 <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 3 √ó 2[39m</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#&gt;        x      y</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt;    [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m  2.86   24.6 </span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; [38;5;250m2[39m -[31m2[39m[31m.[39m[31m93[39m  -[31m36[39m[31m.[39m[31m6[39m </span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt; [38;5;250m3[39m -[31m0[39m[31m.[39m[31m473[39m  -[31m7[39m[31m.[39m[31m44[39m</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>Example1 <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 2 √ó 2[39m</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt;       x     y</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt;   [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m -[31m1[39m[31m.[39m[31m64[39m -[31m20[39m[31m.[39m[31m2[39m</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt; [38;5;250m2[39m -[31m4[39m[31m.[39m[31m10[39m -[31m40[39m[31m.[39m[31m5[39m</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="co"># and so on</span></span></code></pre></div>
</div>
<div id="pre-defined-simulations" class="section level2">
<h2>Pre-defined simulations</h2>
<p>Although students or instructors may create their own simulations
using <code>datasim_make()</code>, they will want to get started using
some of the pre-defined simulations that come with the
<code>{LST}</code> package. These are named with the prefix
<code>sim_</code>, as in <code>sim_00</code>, <code>sim_01</code>, ‚Ä¶,
<code>sim_12</code>, <code>sim_vaccine</code>, and so on.</p>
<p>There are two ways to see what are the rules of these predefined
simulations.</p>
<ol style="list-style-type: decimal">
<li>Print out the rules, e.g.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">print</span>(sim_04) <span class="co"># One of the simulations in {LST}</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#&gt; Simulation object</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#&gt; ------------</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#&gt; [1] a &lt;- rnorm(n)</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#&gt; [2] b &lt;- rnorm(n)</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&gt; [3] c &lt;- rnorm(n)</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&gt; [4] d &lt;- a + b + c + rnorm(n)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Draw a <strong>graph</strong> of the connections between rules,
e.g.¬†in <code>dag_04</code> rule <code>d</code> receives inputs from
<code>a</code>, <code>b</code>, and <code>c</code>, but none of those
other rules are connected to one another.</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">dag_draw</span>(sim_04)</span></code></pre></div>
<p><img src="DAGs_files/figure-html/DAGsMFIYTT-1.png" width="700" /></p>
<p>The term for the mathematical graphs corresponding to data simulation
rules is ‚Äúdirected acyclic graph‚Äù (DAG, for short).</p>
</div>
<div id="introducing-causality" class="section level2">
<h2>Introducing causality</h2>
<p>The rules of a data simulation form a network; some variables depend
on others. In mathematics, networks are often represented by
<strong>graphs</strong>, that is, systems with nodes and edges
connecting the nodes. In data simulations, each rule specifies the
inputs (if any) on the right-hand side of <code>&lt;-</code> and how
those inputs specify the value of the variable named on the left-hand
side of <code>&lt;-</code>. In other words, data simulations correspond
to the mathematical idea of a <strong>directed graph</strong>.</p>
<p>But not all directed graphs are admissible. For instance, the
following statement attempts to make a simulation with two variables,
each of which sets the values of the other.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>cycle <span class="ot">&lt;-</span> <span class="fu">datasim_make</span>(x <span class="ot">&lt;-</span> y, y <span class="ot">&lt;-</span> <span class="sc">-</span>x)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#&gt; Error in igraph::topo_sort(datasim_to_igraph(sim, report_hidden = TRUE)): At core/properties/dag.c:114 : The graph has cycles; topological sorting is only possible in acyclic graphs, Invalid value</span></span></code></pre></div>
<p>The mathematically oriented reader may be tempted to interpret the
above as a set of <em>differential equation</em>, for instance the
similar looking <span class="math display">\[\frac{dx}{dt} = y, \
\frac{dy}{dt} = -x\]</span>. The differential equation is a legitimate
mathematical object and has solutions, that is <span
class="math inline">\(x(t)\)</span> and <span
class="math inline">\(y(t)\)</span>. And in the differential equation,
<span class="math inline">\(y\)</span> clearly influences <span
class="math inline">\(x\)</span> and <em>vice versa</em>. Or, to be
precise, the <em>present$ value of <span
class="math inline">\(x\)</span> influences the </em>future values* of
<span class="math inline">\(y\)</span>. (For R functions pertaining to
differential equations, see the <code>{mosaicCalc}</code> package, which
is not related to <code>{LST}</code> other than by authorship and
affiliation with [Project MOSAIC]{<a href="https://www.mosaic-web.org/"
class="uri">https://www.mosaic-web.org/</a>}.)</p>
<p>In a data simulation, in contrast, the rows in the output data are
all independent realizations of the simulation rules. For instance, in
<code>sim_04</code> (graphed above), for each row a value of
<code>a</code> is generated autonomously (‚Äúexogenously‚Äù), as are the
values of <code>b</code> and <code>c</code>. The <code>d</code> variable
for that row is the arithmetic sum <code>a + b + c</code> with a bit of
exogenous noise added as well.</p>
<p>The problem with the proposed simulation <code>cycle</code> is that
to find <code>x</code> for a row, you must first know <code>y</code>,
and to find <code>y</code> for a row, you must already know
<code>x</code>. In order to avoid the impossible situation of a cycle in
a data simulation, each successive rule can depend only on the rules
that come before it. Such a network is called <strong>acyclic</strong>:
without cycles. Consequently, data simulations correspond to Directed
Acyclic Graphs (DAGs).</p>
<p>As you may know, DAGs play an important role in statistical
<strong>causal inference</strong>. Consequently, DAGs are an important
theme in <em>Lessons in Statistical Thinking</em>.</p>
<p>Data simulations can be useful in teaching causal concepts. To
illustrate, consider the <code>sim_vaccine</code> simulation provided by
the <code>{LST}</code> package. The simulation is a cartoon about how
flu vaccinations might reduce mortality from the flu. We can look at
<code>sim_vaccine</code> in the usual ways:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">print</span>(sim_vaccine)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#&gt; Simulation object</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt; ------------</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt; [1] died &lt;- bernoulli(logodds = .s, labels = c(&quot;yes&quot;, &quot;no&quot;))</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co">#&gt; [2] vaccinated &lt;- bernoulli(logodds = .v, labels = c(&quot;none&quot;, &quot;yes&quot;))</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co">#&gt; [3] health &lt;- bernoulli(logodds = .h, labels = c(&quot;poor&quot;, &quot;good&quot;))</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt; [4] flu &lt;- bernoulli(logodds = .f)</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="fu">dag_draw</span>(sim_vaccine)</span></code></pre></div>
<p><img src="DAGs_files/figure-html/DAGswTgvGw-1.png" width="700" /></p>
<p>To judge from the graph, which shows no arrows, there are no
connections among the four variables involved in the simulation. This is
a good starting point for a classroom discussion of how the four
variables might be connected in the real world. Different people have
different opinions about this, for example, ‚Äúvaccine deniers‚Äù might
insist that vaccination causes <code>health</code> to deteriorate. A
person more in touch with medical science would see that vaccination
effects the chances of getting the flu, and depending on the person‚Äôs
health a person with the flu is more likely to die.</p>
<p>We can run the simulation and model the resulting data to see if the
data show any connections among the four variables. For instance, it‚Äôs
easy to simulate a study with 10,000 participants whose baseline health
is measured and then are observed: do they get vaccinated, do they get
the flu, do they die?</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> sim_vaccine <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">10000</span>)</span></code></pre></div>
<p>Modeling the data helps us address questions of interest. For
instance, is vaccination associated with reduced odds of getting the
flu?</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>sim_data <span class="sc">|&gt;</span> <span class="fu">model_train</span>(flu <span class="sc">~</span> vaccinated) <span class="sc">|&gt;</span> <span class="fu">conf_interval</span>()</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">#&gt; Waiting for profiling to be done...</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 2 √ó 4[39m</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">#&gt;   term             .lwr   .coef    .upr</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">#&gt;   [3m[38;5;246m&lt;chr&gt;[39m[23m           [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m (Intercept)   -[31m0[39m[31m.[39m[31m0[39m[31m93[4m3[24m[39m -[31m0[39m[31m.[39m[31m0[39m[31m36[4m1[24m[39m  0.021[4m0[24m</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co">#&gt; [38;5;250m2[39m vaccinatedyes -[31m1[39m[31m.[39m[31m35[39m   -[31m1[39m[31m.[39m[31m26[39m   -[31m1[39m[31m.[39m[31m18[39m</span></span></code></pre></div>
<p>The negative coefficient on <code>vaccinated</code> indicates that
vaccination (in the simulation) is associated with lower odds of getting
the flu. Similarly, getting the flu is associated with dieing:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>sim_data <span class="sc">|&gt;</span> <span class="fu">model_train</span>(<span class="fu">zero_one</span>(died, <span class="at">one=</span><span class="st">&quot;yes&quot;</span>) <span class="sc">~</span> flu) <span class="sc">|&gt;</span> <span class="fu">conf_interval</span>()</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">#&gt; Waiting for profiling to be done...</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 2 √ó 4[39m</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">#&gt;   term          .lwr  .coef   .upr</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">#&gt;   [3m[38;5;246m&lt;chr&gt;[39m[23m        [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m (Intercept) -[31m2[39m[31m.[39m[31m21[39m  -[31m2[39m[31m.[39m[31m13[39m  -[31m2[39m[31m.[39m[31m0[39m[31m5[39m </span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">#&gt; [38;5;250m2[39m flu          0.177  0.302  0.426</span></span></code></pre></div>
<p>The positive coefficient on <code>flu</code> demonstrates the
association: getting flu means larger odds of dieing.</p>
<p>You might wonder how associations are formed among the variables in
the simulation when the graph has no edges connecting them. You can
write your own simulation to verify that unconnected variables almost
always produce a confidence interval that includes zero. Only about 5%
of such simulation runs will result in a confidence interval not
including zero. These runs lead to Type I errors.</p>
<p>The reason for the associations seen in the <code>sim_vaccine</code>
data is that there are in fact connections, but they involve variables
in the simulation that aren‚Äôt being reported in the data, so called
‚Äúlurking‚Äù variables. Unlike the real world, in the simulation we can
look at such variables</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">print</span>(sim_vaccine, <span class="at">report_hidden =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">#&gt; Simulation object</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">#&gt; ------------</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">#&gt; [1] .h &lt;- rnorm(n, sd = 1)</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co">#&gt; [2] .v &lt;- 0.2 + 2 * .h + rnorm(n, sd = 0.25)</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#&gt; [3] .f &lt;- -0.5 - 0.5 * bernoulli(logodds = .v) - 1 * .h</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co">#&gt; [4] .s &lt;- 2 - 0.2 * bernoulli(logodds = .f) + 0.4 * (.h + 0.5)</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co">#&gt; [5] died &lt;- bernoulli(logodds = .s, labels = c(&quot;yes&quot;, &quot;no&quot;))</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">#&gt; [6] vaccinated &lt;- bernoulli(logodds = .v, labels = c(&quot;none&quot;, &quot;yes&quot;))</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">#&gt; [7] health &lt;- bernoulli(logodds = .h, labels = c(&quot;poor&quot;, &quot;good&quot;))</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">#&gt; [8] flu &lt;- bernoulli(logodds = .f)</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="fu">dag_draw</span>(sim_vaccine, <span class="at">report_hidden =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="DAGs_files/figure-html/DAGsJsATe2-1.png" width="700" /></p>
<p>The variables <code>health</code>, <code>vaccinated</code>,
<code>flu</code>, and <code>died</code> are merely readouts of internal
variables <code>.h</code>, <code>.v</code>, <code>.f</code> and
<code>.s</code>. Dots starting a variable name are what keeps those
variables hidden, until revealed by the
<code>report_hidden = TRUE</code> argument.</p>
<p>The hidden variables are a nest of connections. For example, better
health (<code>.h</code>) makes vaccination (<code>.v</code>) more
likely.</p>
<p>To generate simulated data that includes the hidden variables, use
the <code>report_hidden=TRUE</code> argument to
<code>sample()</code>.</p>
<p>In a proper clinical trial, vaccination would be assigned at random,
or maybe even blocked with respect to health, age, ‚Ä¶. As it stands,
<code>sim_vaccine</code> is an observational study. To create a
randomized clinical trial‚Äîthat is, an experiment‚Äîwe would need to
intervene to set <code>.v</code>. This can be done with the
<code>datasim_intervene()</code> function, which allows us to specify
new rules and modify existing ones. Like this:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>Randomized_trial_sim <span class="ot">&lt;-</span> <span class="fu">datasim_intervene</span>(sim_vaccine, .v <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="fu">dag_draw</span>(Randomized_trial_sim, <span class="at">report_hidden =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="DAGs_files/figure-html/unnamed-chunk-11-1.png" width="700" /></p>
<p>Note how the graph of <code>RCT</code>differs from the graph of that
of <code>sim_vaccine</code>: there is now no direct connection between
the health variable and vaccination. Generating data from the randomized
clinical trial and modeling the connections between the flu variable
(<code>.f</code>) and the vaccinated variable (<code>.v</code>) shows a
much smaller connection between vaccination and the flu than was seen
with the observational data generated by <code>sim_vaccine</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>RTdata <span class="ot">&lt;-</span> Randomized_trial_sim <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n=</span><span class="dv">10000</span>, <span class="at">report_hidden =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>RTdata <span class="sc">|&gt;</span> <span class="fu">model_train</span>(.f <span class="sc">~</span> .v <span class="sc">+</span> .h) <span class="sc">|&gt;</span> <span class="fu">conf_interval</span>()</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 3 √ó 4[39m</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co">#&gt;   term           .lwr   .coef    .upr</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co">#&gt;   [3m[38;5;246m&lt;chr&gt;[39m[23m         [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m (Intercept) -[31m0[39m[31m.[39m[31m751[39m  -[31m0[39m[31m.[39m[31m750[39m  -[31m0[39m[31m.[39m[31m749[39m </span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co">#&gt; [38;5;250m2[39m .v          -[31m0[39m[31m.[39m[31m0[39m[31m49[4m6[24m[39m -[31m0[39m[31m.[39m[31m0[39m[31m49[4m5[24m[39m -[31m0[39m[31m.[39m[31m0[39m[31m49[4m3[24m[39m</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="co">#&gt; [38;5;250m3[39m .h          -[31m1[39m[31m.[39m[31m00[39m   -[31m1[39m[31m.[39m[31m00[39m   -[31m0[39m[31m.[39m[31m999[39m</span></span></code></pre></div>
<p>Of course, <code>sim_vaccine</code> is just a simulation and may not
accord with how things work in the real world. But if the real world
were like <code>sim_vaccine</code>, we would be able to untangle the
confounded connections by running the experiment. Such untangling can
also be done by the appropriate choice of covariates in a model.</p>
</div>
<div id="sec-why-datasim" class="section level2">
<h2>Why <code>datasim_make()</code>?</h2>
<p>Many textbooks that use R simulations arrange the code as a sequence
of R statements. For instance, the simulation <code>Example1</code>
shown at the start of this document could be written in three
statements.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">2</span>) </span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">+</span> <span class="dv">10</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span></code></pre></div>
<p>This approach is viable in terms of the numbers generated for
<code>x</code> and <code>y</code>, but it has several shortcomings.</p>
<ul>
<li>The variables have not been assembled in a data frame, so graphing,
summarizing, and modeling of the variables has to be done
accordingly.</li>
<li>There is no name for the simulation itself, so referring to a
simulation or comparing simulations with different rules is
awkward.</li>
<li>Repeated runs of the simulation are tedious and book-keeping has to
be done by hand.</li>
<li>Analyzing the rules to draw a DAG or to check for cycles is not
easy.</li>
</ul>
<p><code>datasim_make()</code> and <code>sample()</code> avoids such
problems with a very small minimum of extra code, as seen in
<code>Example1</code>.</p>
</div>
<div id="functions-for-simulation-rules" class="section level2">
<h2>Functions for simulation rules</h2>
<p>Many of the rules in simulation can be expressed in mainstream R
code. For example, random numbers can be generated with
<code>rnorm()</code>, <code>rexp()</code>, <code>rbinom()</code>, and
the many other such functions provided by the <code>{stats}</code>
package or other packages. Similarly, arithmetic and other mathematical
operations can be written in the ordinary way.</p>
<p>It is convenient, however, to use special functions provided by
<code>{LST}</code> for writing simulations. These functions simplify any
common situations in simulations.</p>
<ul>
<li><code>categorical()</code> generates specified categorical levels at
random. We‚Äôll give examples using <code>n = 10</code></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>color <span class="ot">&lt;-</span> <span class="fu">categorical</span>(n, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>color</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;red&quot;   &quot;blue&quot;  &quot;blue&quot;  &quot;red&quot;   &quot;green&quot; &quot;red&quot;   &quot;green&quot; &quot;green&quot; &quot;blue&quot; </span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">#&gt; [10] &quot;red&quot;</span></span></code></pre></div>
<p>By default, each level is equally likely to occur. You can specify
probabilities directly using an argument notation:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>color <span class="ot">&lt;-</span> <span class="fu">categorical</span>(n, <span class="at">red =</span> .<span class="dv">1</span>, <span class="at">blue =</span> .<span class="dv">2</span>, <span class="at">green =</span> .<span class="dv">7</span>)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>color</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;green&quot; &quot;green&quot; &quot;green&quot; &quot;green&quot; &quot;green&quot; &quot;green&quot; &quot;green&quot; &quot;blue&quot;  &quot;red&quot;  </span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">#&gt; [10] &quot;blue&quot;</span></span></code></pre></div>
<ul>
<li><code>bernoulli()</code> generates zero-one variables or two-level
categorical variables. The simple default is to make 0 and 1 with equal
probability.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>flip <span class="ot">&lt;-</span> <span class="fu">bernoulli</span>(n)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>flip</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co">#&gt;  [1] 0 0 1 0 0 1 0 1 1 1</span></span></code></pre></div>
<p>You can provide labels for zero and one, producing a categorical
variable:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>flip <span class="ot">&lt;-</span> <span class="fu">bernoulli</span>(n, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;bad&quot;</span>, <span class="st">&quot;good&quot;</span>))</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>flip</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;bad&quot;  &quot;good&quot; &quot;good&quot; &quot;good&quot; &quot;bad&quot;  &quot;good&quot; &quot;bad&quot;  &quot;bad&quot;  &quot;bad&quot;  &quot;good&quot;</span></span></code></pre></div>
<p><code>bernoulli()</code> can also generate outcomes that depend on
other variables, using those variables as either log-odds inputs or
probability [0,1] inputs. See the <code>sim_vaccine</code> presented
above for examples.</p>
<ul>
<li><code>cat2value()</code> Sometimes you want to use a categorical
variable as an input and translate it to numerical values as an output
or, for instance, to specify log-odds in <code>bernoulli()</code>.</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">cat2value</span>(flip, <span class="at">good =</span> <span class="dv">2</span>, <span class="at">bad =</span> <span class="sc">-</span><span class="dv">1</span> )</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>vals</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="co">#&gt;  [1] -1  2  2  2 -1  2 -1 -1 -1  2</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bernoulli</span>(<span class="at">logodds =</span> vals, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;fail&quot;</span>, <span class="st">&quot;succeed&quot;</span>))</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>result</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;fail&quot;    &quot;fail&quot;    &quot;succeed&quot; &quot;succeed&quot; &quot;fail&quot;    &quot;succeed&quot; &quot;fail&quot;   </span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="co">#&gt;  [8] &quot;succeed&quot; &quot;fail&quot;    &quot;fail&quot;</span></span></code></pre></div>
<p>If you don‚Äôt need <code>vals</code> elsewhere in your simulation, you
can combine the two statements into one:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bernoulli</span>(<span class="at">logodds =</span> <span class="fu">cat2value</span>(flip, <span class="at">good=</span><span class="dv">2</span>, <span class="at">bad =</span> <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>result</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co">#&gt;  [1] 1 0 1 1 0 1 1 0 0 1</span></span></code></pre></div>
<ul>
<li><code>block_by()</code> assigns categorical levels randomly, but
arranged in blocks defined by some other variable.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="fu">block_by</span>(color, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;glue&quot;</span>, <span class="st">&quot;nails&quot;</span>, <span class="st">&quot;screws&quot;</span>))</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>treatment</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;glue&quot;   &quot;screws&quot; &quot;glue&quot;   &quot;nails&quot;  &quot;glue&quot;   &quot;screws&quot; &quot;nails&quot;  &quot;screws&quot;</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="co">#&gt;  [9] &quot;glue&quot;   &quot;nails&quot;</span></span></code></pre></div>
<p>Using these same rules in <code>datasim_make()</code> facilitates
running the simulation multiple times and packing each simulation‚Äôs data
as a data frame. To illustrate, it‚Äôs hard to see from the
<code>treatment</code> variable alone that it has been blocked by
<code>color</code>. But once the data are in a data frame, we can use
wrangling or modeling to reveal such patterns. (Don‚Äôt forget the commas
between the rules! Each rule is an argument to
<code>datasim_make()</code>.)</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>all_together <span class="ot">&lt;-</span> <span class="fu">datasim_make</span>(</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  color <span class="ot">&lt;-</span> <span class="fu">categorical</span>(n, <span class="at">red =</span> .<span class="dv">1</span>, <span class="at">blue =</span> .<span class="dv">2</span>, <span class="at">green =</span> .<span class="dv">7</span>),</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  flip <span class="ot">&lt;-</span> <span class="fu">bernoulli</span>(n, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;bad&quot;</span>, <span class="st">&quot;good&quot;</span>)),</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bernoulli</span>(<span class="at">logodds =</span> <span class="fu">cat2value</span>(flip, <span class="at">good=</span><span class="dv">2</span>, <span class="at">bad =</span> <span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  treatment <span class="ot">&lt;-</span> <span class="fu">block_by</span>(color, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;glue&quot;</span>, <span class="st">&quot;nails&quot;</span>, <span class="st">&quot;screws&quot;</span>))</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>)</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>all_together <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">20</span>) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(color)</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 20 √ó 4[39m</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="co">#&gt;    color flip  treatment result</span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="co">#&gt;    [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m      [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 1[39m blue  bad   glue           0</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 2[39m blue  good  nails          1</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 3[39m blue  good  screws         1</span></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 4[39m blue  bad   screws         0</span></span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 5[39m green good  glue           1</span></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 6[39m green bad   nails          0</span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 7[39m green bad   glue           0</span></span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 8[39m green good  screws         1</span></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a><span class="co">#&gt; [38;5;250m 9[39m green good  nails          0</span></span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a><span class="co">#&gt; [38;5;250m10[39m green bad   glue           1</span></span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a><span class="co">#&gt; [38;5;250m11[39m green bad   nails          1</span></span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a><span class="co">#&gt; [38;5;250m12[39m green bad   screws         0</span></span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a><span class="co">#&gt; [38;5;250m13[39m green good  glue           1</span></span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a><span class="co">#&gt; [38;5;250m14[39m green good  nails          1</span></span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a><span class="co">#&gt; [38;5;250m15[39m green bad   screws         0</span></span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a><span class="co">#&gt; [38;5;250m16[39m green good  screws         1</span></span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a><span class="co">#&gt; [38;5;250m17[39m green good  nails          1</span></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a><span class="co">#&gt; [38;5;250m18[39m green bad   glue           0</span></span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a><span class="co">#&gt; [38;5;250m19[39m red   bad   nails          0</span></span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a><span class="co">#&gt; [38;5;250m20[39m red   good  glue           1</span></span></code></pre></div>
<p>In the above data frame, you can see that all the treatments have
been assigned as evenly as possible for each of the colors.</p>
<ul>
<li><code>mix_with()</code> will mix noise with a signal so that the
output has the specified R<sup>2</sup> and variance.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>Mix_them <span class="ot">&lt;-</span> <span class="fu">datasim_make</span>(</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n),</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">mix_with</span>(x, <span class="at">R2 =</span> <span class="fl">0.71</span>, <span class="at">var =</span> <span class="fl">4.35</span>)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>)</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>Dat <span class="ot">&lt;-</span> Mix_them <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>Dat <span class="sc">|&gt;</span> <span class="fu">model_train</span>(y <span class="sc">~</span> x) <span class="sc">|&gt;</span> <span class="fu">R2</span>()</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="co">#&gt;     n k  Rsquared        F     adjR2 p df.num df.denom</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="co">#&gt; 1 100 1 0.7595083 309.4984 0.7570543 0      1       98</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>Dat <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="fu">var</span>(y))</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 1 √ó 1[39m</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a><span class="co">#&gt;   `var(y)`</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a><span class="co">#&gt;      [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m     4.35</span></span></code></pre></div>
<p>The noise being mixed with the signal may incidentally be correlated
with the signal. This leads to R<sup>2</sup> varying around the
specified value. You can avoid this variation (not that you necessarily
want to) by providing the optional argument
<code>exact = TRUE</code>.</p>
</div>
<div id="doubly-stochastic-processes" class="section level2">
<h2>Doubly stochastic processes</h2>
<p>There are many situations where the conditions for a random outcome
are themselves set at random. The <code>bernoulli()</code> process
provides an illustration. Suppose that an outcome ill-vs-healthy is to
be determined at random, but the patient‚Äôs general health condition sets
the probability of falling ill.¬†For instance:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>Sick_sim <span class="ot">&lt;-</span> <span class="fu">datasim_make</span>(</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>  health <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">sd=</span><span class="dv">2</span>), </span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  sick   <span class="ot">&lt;-</span> <span class="fu">bernoulli</span>(<span class="at">logodds =</span> health, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;ill&quot;</span>, <span class="st">&quot;OK&quot;</span>))</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>)</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>Sim_dat <span class="ot">&lt;-</span> Sick_sim <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">1000</span>)</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>Sim_dat <span class="sc">|&gt;</span> <span class="fu">point_plot</span>(sick <span class="sc">~</span> health)</span></code></pre></div>
<p><img src="DAGs_files/figure-html/unnamed-chunk-23-1.png" width="700" /></p>
<p>A hallmark of such processes is that the <code>n</code> argument
isn‚Äôt needed; the number of random values produced is determined by the
length of an input variable, in this case <code>health</code>.</p>
<p><code>bernoulli()</code> was written specially to achieve this
behavior. It‚Äôs helpful to have a mechanism that will enable any doubly
stochastic behavior. For instance, suppose we want to generate
<code>k</code> a random positive integer and based on <code>k</code>,
another variable <code>y</code> which will be the sum of <code>k</code>
normal processes. It‚Äôs tempting to try to write this as follows:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># This won&#39;t work!</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>sum_sim <span class="ot">&lt;-</span> <span class="fu">datasim_make</span>(</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">take_sample</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">16</span>, <span class="dv">32</span>, <span class="dv">64</span>, <span class="dv">128</span>), <span class="at">n =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">rnorm</span>(k))</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>)</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>sum_sim <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">5</span>)</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 5 √ó 2[39m</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co">#&gt;       k     y</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co">#&gt;   [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m   128  2.37</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="co">#&gt; [38;5;250m2[39m     1  2.37</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="co">#&gt; [38;5;250m3[39m     4  2.37</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="co">#&gt; [38;5;250m4[39m    64  2.37</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a><span class="co">#&gt; [38;5;250m5[39m    32  2.37</span></span></code></pre></div>
<p>This hasn‚Äôt performed as might be expected. All the supposedly random
<code>y</code> values are the same. The reason can be seen from the
documentation for <code>rnorm()</code>. When the <code>n</code> argument
to <code>rnorm()</code> is a vector‚Äîand <code>k</code> will be a vector
of length n = 5 when the sample is generated‚Äîthe length of the vector
determines the number of random numbers generated. Consequently,
<code>sum(rnorm(k))</code> is a simple sum of n random numbers, rather
than a n sums of a varying number of random numbers.</p>
<p>The <code>each()</code> function sets things up so that a separate
calculation is done for each of the n rows in the sample. Each such
calculation draws on the values of the variables for that particular
row. To illustrate:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># This will do what we want!</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>sum_sim <span class="ot">&lt;-</span> <span class="fu">datasim_make</span>(</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">take_sample</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">16</span>, <span class="dv">32</span>, <span class="dv">64</span>, <span class="dv">128</span>), <span class="at">n =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">each</span>(<span class="fu">sum</span>(<span class="fu">rnorm</span>(k)))</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>)</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>sum_sim <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">5</span>)</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="co">#&gt; [38;5;246m# A tibble: 5 √ó 2[39m</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a><span class="co">#&gt;       k      y</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a><span class="co">#&gt;   [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a><span class="co">#&gt; [38;5;250m1[39m     4 -[31m1[39m[31m.[39m[31m32[39m </span></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a><span class="co">#&gt; [38;5;250m2[39m    32 14.9  </span></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a><span class="co">#&gt; [38;5;250m3[39m    32  0.862</span></span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a><span class="co">#&gt; [38;5;250m4[39m    64 -[31m2[39m[31m.[39m[31m63[39m </span></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="co">#&gt; [38;5;250m5[39m    16  1.39</span></span></code></pre></div>
<p>We would need a bigger sample to see the <code>k</code> dependence of
<code>y</code>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>sum_sim <span class="sc">|&gt;</span> <span class="fu">take_sample</span>(<span class="at">n =</span> <span class="dv">10000</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>  <span class="fu">point_plot</span>(y <span class="sc">~</span> k, <span class="at">point_ink =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<p><img src="DAGs_files/figure-html/unnamed-chunk-26-1.png" width="700" /></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>



    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Daniel Kaplan, Randall Pruim.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>
